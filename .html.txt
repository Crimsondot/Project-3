<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ITV308 ITV Project by Umang & Kshitiz</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Basic prose styles for rendered markdown/text */
        .prose {
            color: #d1d5db; /* text-gray-300 */
        }
        .prose br {
            content: "";
            display: block;
            margin-bottom: 0.5em;
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #1f2937; /* bg-gray-800 */
        }
        ::-webkit-scrollbar-thumb {
            background: #4b5563; /* bg-gray-600 */
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280; /* bg-gray-500 */
        }
        /* Ensure icons are sized correctly */
        .lucide {
            width: 1em;
            height: 1em;
            stroke-width: 2;
        }
    </style>
</head>
<body class="bg-gray-900 text-white font-sans antialiased h-screen overflow-hidden">

    <!-- App Container -->
    <div id="app-container" class="h-full">

        <!-- Main App -->
        <div id="mainApp" class="h-full flex bg-gray-900 text-white">
            <!-- Sidebar -->
            <nav class="w-64 bg-gray-800 p-4 flex flex-col flex-shrink-0">
                <div class="flex items-center gap-3 mb-6">
                    <div>
                        <p class="font-semibold text-sm">ITV308 Project</p>
                        <p class="text-xs text-gray-400">Guest Mode</p>
                    </div>
                </div>
                
                <button id="newChatButton" class="w-full bg-blue-600 text-white hover:bg-blue-700 focus:ring-blue-500 flex items-center justify-center gap-2 px-4 py-2 rounded-lg font-semibold transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-900 mb-4">
                    <i data-lucide="plus" class="lucide w-5 h-5"></i>
                    New Chat
                </button>
                
                <div class="flex-1 overflow-y-auto pr-1">
                    <p class="text-xs font-semibold text-gray-400 uppercase mb-2">Conversations</p>
                    <div id="chatListContainer">
                        <p class="text-xs text-gray-500">Chat history is not saved in this mode.</p>
                    </div>
                </div>
            </nav>
            
            <!-- Main Content -->
            <main class="flex-1 flex flex-col h-full overflow-hidden">
                <!-- Header -->
                <header class="flex items-center justify-between p-4 border-b border-gray-700 flex-shrink-0">
                    <h1 class="text-xl font-bold">ITV308 ITV Project by Umang & Kshitiz</h1>
                    <div class="flex items-center gap-6">
                        <nav class="flex gap-4">
                            <button id="chatTabButton" class="px-3 py-1 rounded-md text-sm font-medium bg-blue-600 text-white">
                                <i data-lucide="message-square" class="lucide w-4 h-4 inline-block mr-1"></i>
                                Chat
                            </button>
                            <button id="imageTabButton" class="px-3 py-1 rounded-md text-sm font-medium text-gray-300 hover:bg-gray-700">
                                <i data-lucide="image" class="lucide w-4 h-4 inline-block mr-1"></i>
                                Generate Image
                            </button>
                        </nav>
                        <img src="Dayalbagh_Educational_Institute_logo.jpg" 
                             alt="Institute Logo" 
                             class="w-10 h-10 rounded-full"
                             onerror="this.style.display='none'">
                    </div>
                </header>
                
                <!-- Content Area -->
                <div class="flex-1 overflow-y-auto">
                    
                    <!-- Chat Interface -->
                    <div id="chatInterface" class="flex flex-col h-full p-4">
                        <div id="messagesContainer" class="flex-1 overflow-y-auto pr-2">
                            <!-- Messages will be dynamically populated here -->
                            <div id="chatWelcomeMessage" class="flex items-center justify-center h-full">
                                <div class="text-center text-gray-500">
                                    <i data-lucide="brain" class="lucide w-24 h-24 mx-auto"></i>
                                    <p>Start a new conversation.</p>
                                </div>
                            </div>
                        </div>
                        
                        <div id="chatLoadingIndicator" class="hidden flex items-center gap-3 p-4">
                            <div class="p-2 bg-gray-600 rounded-full">
                                <i data-lucide="brain" class="lucide w-5 h-5 text-white animate-spin"></i>
                            </div>
                            <p>Gemini is thinking...</p>
                        </div>
        
                        <div class="mt-4">
                            <div id="pendingImagePreview" class="hidden relative w-32 h-32 mb-2 p-2 bg-gray-700 rounded-lg">
                                <img id="pendingImage" src="" alt="Pending upload" class="w-full h-full object-cover rounded">
                                <button id="clearPendingImage" class_="absolute -top-2 -right-2 bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center font-bold" title="Remove image">
                                    &times;
                                </button>
                            </div>
                            
                            <form id="chatForm" class="flex items-center gap-2 p-3 bg-gray-800 rounded-lg">
                                <input id="chatInput" type="text" placeholder="Type your message..." class="w-full p-3 bg-gray-800 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-0" autocomplete="off">
                                <button type="submit" id="chatSendButton" class="bg-blue-600 text-white hover:bg-blue-700 focus:ring-blue-500 rounded-full w-10 h-10 p-0 flex items-center justify-center flex-shrink-0" disabled>
                                    <i data-lucide="send" class="lucide w-5 h-5"></i>
                                </button>
                            </form>
                        </div>
                    </div>

                    <!-- Image Generator -->
                    <div id="imageGenerator" class="hidden p-6 h-full flex flex-col">
                        <h2 class="text-2xl font-bold mb-4">Image Generation</h2>
                        <p class="text-gray-400 mb-6">Describe the image you want to create using Imagen.</p>
                        
                        <form id="imageForm" class="flex gap-2 mb-4">
                            <input id="imagePrompt" type="text" placeholder="e.g., A photo of a corgi wearing a chef's hat" class="w-full p-3 bg-gray-700 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500" autocomplete="off">
                            <button type="submit" id="imageGenerateButton" class="bg-blue-600 text-white hover:bg-blue-700 focus:ring-blue-500 flex items-center justify-center gap-2 px-4 py-2 rounded-lg font-semibold transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-900 flex-shrink-0">
                                <i data-lucide="star" class="lucide w-5 h-5"></i>
                                <span>Generate</span>
                            </button>
                        </form>
                
                        <div id="imagePreviewContainer" class="flex-1 bg-gray-800 rounded-lg flex items-center justify-center relative overflow-hidden">
                            <div id="imagePlaceholder" class="text-center text-gray-500">
                                <i data-lucide="image" class="lucide w-24 h-24 mx-auto"></i>
                                <p>Your generated image will appear here.</p>
                            </div>
                            <div id="imageLoadingIndicator" class="hidden flex flex-col items-center">
                                <i data-lucide="loader-2" class="lucide w-12 h-12 text-blue-500 animate-spin"></i>
                                <p class="text-gray-300 mt-4">Creating your image...</p>
                            </div>
                            <img id="generatedImage" src="" alt="Generated content" class="hidden object-contain max-w-full max-h-full">
                            <div id="imageError" class="hidden text-center p-4">
                                <p class="text-red-400"></p>
                            </div>
                            <div id="imageActions" class="hidden absolute top-4 right-4 flex gap-2">
                                <button id="discussImageButton" class="bg-blue-600 text-white hover:bg-blue-700 flex items-center justify-center gap-2 px-4 py-2 rounded-lg font-semibold transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-900">
                                    <i data-lucide="message-square" class="lucide w-5 h-5"></i>
                                    Discuss
                                </button>
                            </div>
                        </div>
                    </div>

                </div>
            </main>
        </div>
    </div>

    <!-- Firebase SDK (Not needed for Auth/Firestore anymore) -->
    <script type="module">
        // --- Config ---
        const geminiApiKey = ""; // Provided by environment
        const geminiApiHost = "https://generativelanguage.googleapis.com";
        const geminiTextModel = "gemini-2.5-flash-preview-09-2025";
        const geminiVisionModel = "gemini-2.5-flash-preview-09-2025";
        const imagenModel = "imagen-3.0-generate-002";
        
        // --- State Variables ---
        let activeTab = 'chat';
        let pendingImage = null; // { base64, mimeType }
        let generatedImageData = null; // { base64, mimeType }
        let chatHistory = []; // Local chat history

        // --- DOM Selectors ---
        const newChatButton = document.getElementById('newChatButton');
        const chatListContainer = document.getElementById('chatListContainer');
        
        const chatTabButton = document.getElementById('chatTabButton');
        const imageTabButton = document.getElementById('imageTabButton');
        const chatInterface = document.getElementById('chatInterface');
        const imageGenerator = document.getElementById('imageGenerator');
        
        // Chat UI
        const messagesContainer = document.getElementById('messagesContainer');
        const chatWelcomeMessage = document.getElementById('chatWelcomeMessage');
        const chatLoadingIndicator = document.getElementById('chatLoadingIndicator');
        const pendingImagePreview = document.getElementById('pendingImagePreview');
        const pendingImageEl = document.getElementById('pendingImage');
        const clearPendingImage = document.getElementById('clearPendingImage');
        const chatForm = document.getElementById('chatForm');
        const chatInput = document.getElementById('chatInput');
        const chatSendButton = document.getElementById('chatSendButton');

        // Image UI
        const imageForm = document.getElementById('imageForm');
        const imagePrompt = document.getElementById('imagePrompt');
        const imageGenerateButton = document.getElementById('imageGenerateButton');
        const imagePreviewContainer = document.getElementById('imagePreviewContainer');
        const imagePlaceholder = document.getElementById('imagePlaceholder');
        const imageLoadingIndicator = document.getElementById('imageLoadingIndicator');
        const generatedImageEl = document.getElementById('generatedImage');
        const imageError = document.getElementById('imageError');
        const imageActions = document.getElementById('imageActions');
        const discussImageButton = document.getElementById('discussImageButton');

        // --- API Functions ---

        async function fetchWithRetry(url, options, maxRetries = 5) {
            let delay = 1000;
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.ok) return response;
                    if (response.status >= 400 && response.status < 500) {
                        throw new Error(`Client Error: ${response.status} ${response.statusText}`);
                    }
                    console.warn(`API call failed with status ${response.status}. Retrying in ${delay}ms...`);
                } catch (error) {
                    if (error.name === 'TypeError' || error.message.includes('Failed to fetch')) {
                        console.warn(`Network error. Retrying in ${delay}ms...`, error);
                    } else {
                        throw error;
                    }
                }
                await new Promise(resolve => setTimeout(resolve, delay));
                delay *= 2;
            }
            throw new Error(`Failed to fetch after ${maxRetries} retries.`);
        }

        async function generateText(history, prompt, imageParts = []) {
            const apiUrl = `${geminiApiHost}/v1beta/models/${geminiTextModel}:generateContent?key=${geminiApiKey}`;
            const contents = [
                ...history.map(msg => ({
                    role: msg.role === 'user' ? 'user' : 'model',
                    parts: msg.parts
                })),
                { role: 'user', parts: [...imageParts, { text: prompt }] }
            ];
            const payload = { contents };
            try {
                const response = await fetchWithRetry(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                return result.candidates?.[0]?.content?.parts || [{ text: "Error: No response from model." }];
            } catch (error) {
                console.error("Text Generation Error:", error);
                return [{ text: `Error: ${error.message}` }];
            }
        }

        async function generateImage(prompt) {
            const apiUrl = `${geminiApiHost}/v1beta/models/${imagenModel}:predict?key=${geminiApiKey}`;
            const payload = {
                instances: [{ prompt: prompt }],
                parameters: { "sampleCount": 1 }
            };
            try {
                const response = await fetchWithRetry(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                if (result.predictions && result.predictions[0]?.bytesBase64Encoded) {
                    return `data:image/png;base64,${result.predictions[0].bytesBase64Encoded}`;
                } else {
                    throw new Error("Invalid response structure from Imagen API.");
                }
            } catch (error) {
                console.error("Image Generation Error:", error);
                throw error;
            }
        }

        async function generateFromImage(prompt, base64Image, mimeType) {
            const apiUrl = `${geminiApiHost}/v1beta/models/${geminiVisionModel}:generateContent?key=${geminiApiKey}`;
            const contents = [{
                role: "user",
                parts: [
                    { text: prompt },
                    { inlineData: { mimeType, data: base64Image } }
                ]
            }];
            const payload = { contents };
            try {
                const response = await fetchWithRetry(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                return result.candidates?.[0]?.content?.parts || [{ text: "Error: No response from model." }];
            } catch (error) {
                console.error("Image Vision Error:", error);
                return [{ text: `Error: ${error.message}` }];
            }
        }

        // --- UI Render Functions ---
        
        function showTab(tabId) {
            if (tabId === 'chat') {
                activeTab = 'chat';
                chatInterface.classList.remove('hidden');
                chatInterface.classList.add('flex');
                imageGenerator.classList.add('hidden');
                chatTabButton.classList.add('bg-blue-600', 'text-white');
                chatTabButton.classList.remove('text-gray-300', 'hover:bg-gray-700');
                imageTabButton.classList.add('text-gray-300', 'hover:bg-gray-700');
                imageTabButton.classList.remove('bg-blue-600', 'text-white');
            } else {
                activeTab = 'image';
                imageGenerator.classList.remove('hidden');
                imageGenerator.classList.add('flex');
                chatInterface.classList.add('hidden');
                imageTabButton.classList.add('bg-blue-600', 'text-white');
                imageTabButton.classList.remove('text-gray-300', 'hover:bg-gray-700');
                chatTabButton.classList.add('text-gray-300', 'hover:bg-gray-700');
                chatTabButton.classList.remove('bg-blue-600', 'text-white');
            }
        }

        function renderMessages(messageList) {
            messagesContainer.innerHTML = ''; // Clear messages
            if (messageList.length === 0) {
                chatWelcomeMessage.classList.remove('hidden');
            } else {
                chatWelcomeMessage.classList.add('hidden');
                messageList.forEach(msg => {
                    messagesContainer.appendChild(createMessageElement(msg));
                });
                // Scroll to bottom
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
            lucide.createIcons(); // Re-render icons
        }

        function createMessageElement(msg) {
            const div = document.createElement('div');
            const bgColor = msg.role === 'user' ? 'bg-gray-700' : 'bg-gray-800';
            const iconName = msg.role === 'user' ? 'user' : 'brain';
            const displayName = msg.role === 'model' ? 'Gemini' : 'You';
            
            const textContent = msg.parts.filter(p => p.text).map(p => p.text).join('\n').replace(/\n/g, '<br />');
            const imageParts = msg.parts.filter(p => p.inlineData);

            let imagesHTML = '';
            if (imageParts.length > 0) {
                imagesHTML = imageParts.map(part => 
                    `<img src="data:${part.inlineData.mimeType};base64,${part.inlineData.data}" alt="Chat content" class="max-w-xs rounded-lg mt-2">`
                ).join('');
            }
            
            div.className = `p-4 rounded-lg ${bgColor} mb-4`;
            div.innerHTML = `
                <div class="flex items-start gap-3">
                    <div class="p-2 bg-gray-600 rounded-full flex-shrink-0">
                        <i data-lucide="${iconName}" class="lucide w-5 h-5 text-white"></i>
                    </div>
                    <div class="flex-1 min-w-0">
                        <span class="font-bold capitalize">${displayName}</span>
                        ${imagesHTML}
                        ${textContent ? `<div class="prose max-w-none text-gray-200 mt-1">${textContent}</div>` : ''}
                    </div>
                </div>
            `;
            return div;
        }
        
        function setChatLoading(isLoading) {
            if (isLoading) {
                chatLoadingIndicator.classList.remove('hidden');
                chatInput.disabled = true;
                chatSendButton.disabled = true;
            } else {
                chatLoadingIndicator.classList.add('hidden');
                chatInput.disabled = false;
                chatSendButton.disabled = false;
                updateSendButtonState(); // Re-check button state
                chatInput.focus();
            }
        }
        
        function updateSendButtonState() {
            const hasText = chatInput.value.trim().length > 0;
            const hasImage = pendingImage !== null;
            chatSendButton.disabled = !hasText && !hasImage;
        }

        // --- Event Handlers ---

        function handleNewChat() {
            chatHistory = [];
            renderMessages(chatHistory);
            pendingImage = null;
            pendingImagePreview.classList.add('hidden');
            chatInput.value = '';
            showTab('chat');
        }

        async function handleChatSubmit(event) {
            event.preventDefault();
            const prompt = chatInput.value.trim();
            
            if (!prompt && !pendingImage) return;

            const userMessage = {
                role: "user",
                parts: []
            };

            if (pendingImage) {
                userMessage.parts.push({
                    inlineData: {
                        data: pendingImage.base64,
                        mimeType: pendingImage.mimeType
                    }
                });
            }
            if (prompt) {
                userMessage.parts.push({ text: prompt });
            }

            chatHistory.push(userMessage);
            renderMessages(chatHistory);

            // Clear input
            chatInput.value = '';
            pendingImagePreview.classList.add('hidden');
            const imageToProcess = pendingImage; // Copy before clearing
            pendingImage = null;
            updateSendButtonState();
            setChatLoading(true);

            try {
                // Get chat history for API (all but the last message)
                const historyForApi = chatHistory.slice(0, -1).map(msg => ({ 
                    role: msg.role, 
                    parts: msg.parts 
                }));

                // 4. Call Gemini API
                let modelParts = [];
                if (imageToProcess) {
                    modelParts = await generateFromImage(prompt, imageToProcess.base64, imageToProcess.mimeType);
                } else {
                    modelParts = await generateText(historyForApi, prompt);
                }

                // 5. Save model response
                const modelMessage = {
                    role: "model",
                    parts: modelParts
                };
                chatHistory.push(modelMessage);
                renderMessages(chatHistory);

            } catch (err) {
                console.error("Error sending message:", err);
                const errorMsg = {
                    role: "model",
                    parts: [{ text: `Sorry, something went wrong: ${err.message}` }]
                };
                chatHistory.push(errorMsg);
                renderMessages(chatHistory);
            } finally {
                setChatLoading(false);
            }
        }
        
        async function handleImageSubmit(event) {
            event.preventDefault();
            const prompt = imagePrompt.value.trim();
            if (!prompt) return;
            
            // Reset UI
            imagePlaceholder.classList.add('hidden');
            imageError.classList.add('hidden');
            generatedImageEl.classList.add('hidden');
            imageActions.classList.add('hidden');
            imageLoadingIndicator.classList.remove('hidden');
            imageGenerateButton.disabled = true;
            imageGenerateButton.querySelector('span').textContent = 'Generating...';

            // --- FIX: Icon replacement ---
            // Remove old icon
            const oldIcon = imageGenerateButton.querySelector('svg');
            if (oldIcon) {
                oldIcon.remove();
            }
            // Add new loading icon
            const newIcon = document.createElement('i');
            newIcon.setAttribute('data-lucide', 'loader-2');
            newIcon.className = 'lucide w-5 h-5 animate-spin';
            imageGenerateButton.prepend(newIcon); // Add it before the span
            lucide.createIcons();
            // --- END FIX ---
            
            generatedImageData = null;

            try {
                const imageUrl = await generateImage(prompt);
                generatedImageEl.src = imageUrl;
                generatedImageEl.classList.remove('hidden');
                imageActions.classList.remove('hidden');
                
                // Store base64 data for "Discuss"
                const [header, data] = imageUrl.split(',');
                const mimeType = header.match(/:(.*?);/)[1];
                generatedImageData = { base64: data, mimeType: mimeType };
                
            } catch (err) {
                console.error(err);
                imageError.querySelector('p').textContent = `Error: ${err.message}`;
                imageError.classList.remove('hidden');
            } finally {
                imageLoadingIndicator.classList.add('hidden');
                imageGenerateButton.disabled = false;
                imageGenerateButton.querySelector('span').textContent = 'Generate';

                // --- FIX: Icon replacement ---
                // Remove loading icon
                const loadingIcon = imageGenerateButton.querySelector('svg'); // Find whatever svg is there
                if (loadingIcon) {
                    loadingIcon.remove();
                }
                // Add new star icon
                const starIcon = document.createElement('i');
                starIcon.setAttribute('data-lucide', 'star');
                starIcon.className = 'lucide w-5 h-5';
                imageGenerateButton.prepend(starIcon);
                lucide.createIcons();
                // --- END FIX ---
            }
        }
        
        function handleDiscussImage() {
            if (!generatedImageData) return;
            
            pendingImage = generatedImageData;
            pendingImageEl.src = `data:${generatedImageData.mimeType};base64,${generatedImageData.base64}`;
            pendingImagePreview.classList.remove('hidden');
            chatInput.value = 'Tell me about this image I generated...';
            updateSendButtonState();
            showTab('chat');
        }

        // --- Add Static Event Listeners ---
        newChatButton.onclick = handleNewChat;
        
        chatTabButton.onclick = () => showTab('chat');
        imageTabButton.onclick = () => showTab('image');
        
        chatForm.onsubmit = handleChatSubmit;
        imageForm.onsubmit = handleImageSubmit;
        discussImageButton.onclick = handleDiscussImage;
        
        clearPendingImage.onclick = () => {
            pendingImage = null;
            pendingImagePreview.classList.add('hidden');
            if (chatInput.value === 'Tell me about this image I generated...') {
                chatInput.value = '';
            }
            updateSendButtonState();
        };
        
        chatInput.oninput = updateSendButtonState;
        
        // --- App Start ---
        lucide.createIcons(); // Initial icon render
        updateSendButtonState();

    </script>
</body>
</html>

